"use strict";(self.webpackChunkavalonia_docs=self.webpackChunkavalonia_docs||[]).push([[61142],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var i=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,o=function(e,t){if(null==e)return{};var n,i,o={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=i.createContext({}),d=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=d(e.components);return i.createElement(l.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},c=i.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=d(n),c=o,h=u["".concat(l,".").concat(c)]||u[c]||m[c]||a;return n?i.createElement(h,r(r({ref:t},p),{},{components:n})):i.createElement(h,r({ref:t},p))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,r=new Array(a);r[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:o,r[1]=s;for(var d=2;d<a;d++)r[d]=n[d];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}c.displayName="MDXCreateElement"},72495:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>a,metadata:()=>s,toc:()=>d});var i=n(87462),o=(n(67294),n(3905));const a={id:"index",title:"Headless Platform"},r=void 0,s={unversionedId:"concepts/headless/index",id:"concepts/headless/index",title:"Headless Platform",description:"Introduction",source:"@site/docs/concepts/headless/index.md",sourceDirName:"concepts/headless",slug:"/concepts/headless/",permalink:"/avalonia-docs/docs/next/concepts/headless/",draft:!1,editUrl:"https://github.com/AvaloniaUI/avalonia-docs/tree/main/docs/concepts/headless/index.md",tags:[],version:"current",frontMatter:{id:"index",title:"Headless Platform"},sidebar:"documentationSidebar",previous:{title:"Taking More Control in Code",permalink:"/avalonia-docs/docs/next/concepts/templates/implement-idatatemplate"},next:{title:"Headless Testing with XUnit",permalink:"/avalonia-docs/docs/next/concepts/headless/headless-xunit"}},l={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Getting Started",id:"getting-started",level:2},{value:"Simulating User Input",id:"simulating-user-input",level:2},{value:"<code>Window.KeyPress(Key key, RawInputModifiers modifiers)</code>",id:"windowkeypresskey-key-rawinputmodifiers-modifiers",level:4},{value:"<code>Window.KeyRelease(Key key, RawInputModifiers modifiers)</code>",id:"windowkeyreleasekey-key-rawinputmodifiers-modifiers",level:4},{value:"<code>Window.KeyTextInput(string text)</code>",id:"windowkeytextinputstring-text",level:4},{value:"<code>Window.MouseDown(Point point, MouseButton button, RawInputModifiers modifiers)</code>",id:"windowmousedownpoint-point-mousebutton-button-rawinputmodifiers-modifiers",level:4},{value:"<code>Window.MouseMove(Point point, MouseButton button, RawInputModifiers modifiers)</code>",id:"windowmousemovepoint-point-mousebutton-button-rawinputmodifiers-modifiers",level:4},{value:"<code>Window.MouseUp(Point point, MouseButton button, RawInputModifiers modifiers)</code>",id:"windowmouseuppoint-point-mousebutton-button-rawinputmodifiers-modifiers",level:4},{value:"<code>Window.MouseWheel(Point point, Vector delta, RawInputModifiers modifiers)</code>",id:"windowmousewheelpoint-point-vector-delta-rawinputmodifiers-modifiers",level:4},{value:"<code>Window.DragDrop(Point point, RawDragEventType type, DataObject data, DragDropEffects effects, RawInputModifiers modifiers)</code>",id:"windowdragdroppoint-point-rawdrageventtype-type-dataobject-data-dragdropeffects-effects-rawinputmodifiers-modifiers",level:4},{value:"Capturing the Last Rendered Frame",id:"capturing-the-last-rendered-frame",level:2},{value:"Simulating User Delay",id:"simulating-user-delay",level:2}],p={toc:d},u="wrapper";function m(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,i.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"The headless platform in AvaloniaUI provides the capability to run Avalonia applications without a visible graphical user interface (GUI). This allows for testing and automation scenarios on systems that lack a graphical environment, such as servers or continuous integration/continuous deployment (CI/CD) environments."),(0,o.kt)("p",null,"By utilizing the headless platform, you can perform UI testing, execute application scenarios, and validate functionality in a headless environment, saving time and resources compared to manual testing."),(0,o.kt)("h2",{id:"getting-started"},"Getting Started"),(0,o.kt)("p",null,"While the Headless platform can be initialized without any dependencies, for convenience, we have created integration packages for common unit testing platforms:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"./headless-xunit"},"Headless Testing with XUnit")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"./headless-nunit"},"Headless Testing with NUnit")),(0,o.kt)("li",{parentName:"ul"},"If you are using another platform or need more control: ",(0,o.kt)("a",{parentName:"li",href:"./headless-custom"},"Manual setup of the Headless platform"))),(0,o.kt)("h2",{id:"simulating-user-input"},"Simulating User Input"),(0,o.kt)("p",null,"As the headless platform doesn't have any real input, every event needs to be raised from the unit test. The Avalonia.Headless package is shipped with a number of helper methods that can be used:"),(0,o.kt)("h4",{id:"windowkeypresskey-key-rawinputmodifiers-modifiers"},(0,o.kt)("inlineCode",{parentName:"h4"},"Window.KeyPress(Key key, RawInputModifiers modifiers)")),(0,o.kt)("p",null,"Simulates a keyboard press on the headless window/toplevel."),(0,o.kt)("h4",{id:"windowkeyreleasekey-key-rawinputmodifiers-modifiers"},(0,o.kt)("inlineCode",{parentName:"h4"},"Window.KeyRelease(Key key, RawInputModifiers modifiers)")),(0,o.kt)("p",null,"Simulates a keyboard release on the headless window/toplevel."),(0,o.kt)("h4",{id:"windowkeytextinputstring-text"},(0,o.kt)("inlineCode",{parentName:"h4"},"Window.KeyTextInput(string text)")),(0,o.kt)("p",null,"Simulates a text input event on the headless window/toplevel."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"This event is independent of KeyPress and KeyRelease. If you need to simulate text input to a TextBox or a similar control, please use KeyTextInput.")),(0,o.kt)("h4",{id:"windowmousedownpoint-point-mousebutton-button-rawinputmodifiers-modifiers"},(0,o.kt)("inlineCode",{parentName:"h4"},"Window.MouseDown(Point point, MouseButton button, RawInputModifiers modifiers)")),(0,o.kt)("p",null,"Simulates a mouse down event on the headless window/toplevel."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"In the headless platform, there is a single mouse pointer. There are no helper methods for touch or pen input.")),(0,o.kt)("h4",{id:"windowmousemovepoint-point-mousebutton-button-rawinputmodifiers-modifiers"},(0,o.kt)("inlineCode",{parentName:"h4"},"Window.MouseMove(Point point, MouseButton button, RawInputModifiers modifiers)")),(0,o.kt)("p",null,"Simulates a mouse move event on the headless window/toplevel."),(0,o.kt)("h4",{id:"windowmouseuppoint-point-mousebutton-button-rawinputmodifiers-modifiers"},(0,o.kt)("inlineCode",{parentName:"h4"},"Window.MouseUp(Point point, MouseButton button, RawInputModifiers modifiers)")),(0,o.kt)("p",null,"Simulates a mouse up event on the headless window/toplevel."),(0,o.kt)("h4",{id:"windowmousewheelpoint-point-vector-delta-rawinputmodifiers-modifiers"},(0,o.kt)("inlineCode",{parentName:"h4"},"Window.MouseWheel(Point point, Vector delta, RawInputModifiers modifiers)")),(0,o.kt)("p",null,"Simulates a mouse wheel event on the headless window/toplevel."),(0,o.kt)("h4",{id:"windowdragdroppoint-point-rawdrageventtype-type-dataobject-data-dragdropeffects-effects-rawinputmodifiers-modifiers"},(0,o.kt)("inlineCode",{parentName:"h4"},"Window.DragDrop(Point point, RawDragEventType type, DataObject data, DragDropEffects effects, RawInputModifiers modifiers)")),(0,o.kt)("p",null,"Simulates a drag and drop target event on the headless window/toplevel. This event simulates a user moving files from another app to the current app."),(0,o.kt)("p",null,"A simple button click test is a typical example where these methods can be used:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp"},"// Create window and button:\nvar button = new Button\n{\n    HorizontalAlignment = HorizontalAlignment.Stretch,\n    VerticalAlignment = VerticalAlignment.Stretch\n};\nvar window = new Window\n{\n    Width = 100,\n    Height = 100,\n    Content = button\n};\n\n// Subscribe to the button click event:\nvar buttonClicked = false;\nbutton.Click += (_, _) => buttonClicked = true;\n\n// Show the window:\nwindow.Show();\n\n// Simulate mouse events with a click (mouse down + up):\nwindow.MouseDown(new Point(50, 50), MouseButton.Left);\nwindow.MouseUp(new Point(50, 50), MouseButton.Left);\n\n// Assert that the button was clicked:\nAssert.True(buttonClicked);\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Just like in any other Avalonia application, it's also possible to raise events directly. For example, with button click ",(0,o.kt)("inlineCode",{parentName:"p"},"button.RaiseEvent(new RoutedEventArgs(Button.ClickEvent))"),". This can be more convenient for most use cases but lacks some flexibility with input parameters.")),(0,o.kt)("h2",{id:"capturing-the-last-rendered-frame"},"Capturing the Last Rendered Frame"),(0,o.kt)("p",null,"By default, the Headless platform doesn't render anything and instead has a fake/headless drawing backend enabled. However, it is possible to enable the Skia renderer and use it to capture the last rendered frame, which can be compared with an expected image or used in another way."),(0,o.kt)("p",null,"To enable the Skia renderer, adjust the AppBuilder code as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp",metastring:"title=App.axaml.cs",title:"App.axaml.cs"},"public static AppBuilder BuildAvaloniaApp() => AppBuilder.Configure<TestApplication>()\n    .UseSkia() // enable Skia renderer\n    .UseHeadless(new AvaloniaHeadlessPlatformOptions\n    {\n        UseHeadlessDrawing = false // disable headless drawing\n    });\n")),(0,o.kt)("p",null,"With the real renderer enabled, you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"Window.CaptureRenderedFrame")," helper method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp"},'var window = new Window\n{\n    Content = new TextBlock\n    {\n        Text = "Hello World"\n    }\n};\nwindow.Show();\n\nvar frame = window.CaptureRenderedFrame();\nframe.Save("file.png");\n')),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"CaptureRenderedFrame")," method returns a WriteableBitmap, allowing you to lock it and read pixel data that can be compared in memory.")),(0,o.kt)("h2",{id:"simulating-user-delay"},"Simulating User Delay"),(0,o.kt)("p",null,"In real UI applications, there is always some delay between user interactions, which gives the operating system time to run various tasks in the application. These tasks are often delayed and might include operations such as window resize, which on most platforms (including Headless), is asynchronous."),(0,o.kt)("p",null,"This delay can result in unexpected behavior when some operations have not yet executed."),(0,o.kt)("p",null,"Obvious solution would be to add ",(0,o.kt)("inlineCode",{parentName:"p"},"Task.Delay")," between these operations, but a more efficient option in Avalonia would be to use the ",(0,o.kt)("inlineCode",{parentName:"p"},"Dispatcher")," API, which allows flushing the jobs queue directly:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp"},"var window = new Window();\nwindow.Show();\n\nwindow.Width = 100;\nwindow.Height = 100;\n\n// highlight-start\nDispatcher.UIThread.RunJobs();\n// highlight-end\n\nAssert.AreEqual(new Size(100, 100), window.ClientSize);\n")),(0,o.kt)("p",null,"Additionally, the headless platform provides a method to force the render timer to tick, which can be useful in some scenarios:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp"},"AvaloniaHeadlessPlatform.ForceRenderTimerTick();\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"All input helper methods and ",(0,o.kt)("inlineCode",{parentName:"p"},"CaptureRenderedFrame")," internally use these user delay methods, so there is no need to run them twice!")))}m.isMDXComponent=!0}}]);