"use strict";(self.webpackChunkavalonia_docs=self.webpackChunkavalonia_docs||[]).push([[19177],{40961:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>u,frontMatter:()=>t,metadata:()=>c,toc:()=>d});var o=a(85893),i=a(11151),s=a(97138);const t={info:"displaying-images",title:"Displaying Images"},l=void 0,c={id:"tutorials/music-store-app/displaying-images",title:"Displaying Images",description:"Displaying Album Cover Images",source:"@site/i18n/zh-Hans/docusaurus-plugin-content-docs/version-0.10.x/tutorials/music-store-app/displaying-images.md",sourceDirName:"tutorials/music-store-app",slug:"/tutorials/music-store-app/displaying-images",permalink:"/avalonia-docs/zh-Hans/docs/0.10.x/tutorials/music-store-app/displaying-images",draft:!1,unlisted:!1,editUrl:"https://github.com/AvaloniaUI/avalonia-docs/tree/main/i18n/zh-Hans/docusaurus-plugin-content-docs/version-0.10.x/tutorials/music-store-app/displaying-images.md",tags:[],version:"0.10.x",frontMatter:{info:"displaying-images",title:"Displaying Images"},sidebar:"documentationSidebar",previous:{title:"Searching for Albums",permalink:"/avalonia-docs/zh-Hans/docs/0.10.x/tutorials/music-store-app/searching-for-albums"},next:{title:"Add Items to User Collection",permalink:"/avalonia-docs/zh-Hans/docs/0.10.x/tutorials/music-store-app/add-items-to-users-collection"}},r={},d=[{value:"Displaying Album Cover Images",id:"displaying-album-cover-images",level:2}];function h(e){const n={code:"code",h2:"h2",p:"p",pre:"pre",...(0,i.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"displaying-album-cover-images",children:"Displaying Album Cover Images"}),"\n",(0,o.jsx)(n.p,{children:"So we have the Albums showing with the Artist name and Title, however, if we can download the Album art and display it, this will really bring the app alive."}),"\n",(0,o.jsxs)(n.p,{children:["Fortunately our business logic code provides a convenient ",(0,o.jsx)(n.code,{children:"LoadCoverBitmapAsync"}),". This returns a stream that can be used to load a bitmap from."]}),"\n",(0,o.jsxs)(n.p,{children:["Firstly open ",(0,o.jsx)(n.code,{children:"AlbumViewModel.cs"})," and add a property of type ",(0,o.jsx)(n.code,{children:"Bitmap?"})," named ",(0,o.jsx)(n.code,{children:"Cover"})," using the common pattern so that it can notify the UI when it changes. You will need a ",(0,o.jsx)(n.code,{children:"using Avalonia.Media.Imaging;"})," directive to do so."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-csharp",children:"private Bitmap? _cover;\n\npublic Bitmap? Cover\n{\n    get => _cover;\n    private set => this.RaiseAndSetIfChanged(ref _cover, value);\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:"Next we need to actually load the image data. To do this add the following method."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-csharp",children:"public async Task LoadCover()\n{\n    await using (var imageStream = await _album.LoadCoverBitmapAsync())\n    {\n        Cover = await Task.Run(() => Bitmap.DecodeToWidth(imageStream, 400));\n    }\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:"Notice that it uses a Task to run the Bitmap loading on a background thread, this is so that the UI thread does not get blocked and make the UI unresponsive. Potentially we will be loading many images quickly."}),"\n",(0,o.jsxs)(n.p,{children:["We also use the ",(0,o.jsx)(n.code,{children:"Bitmap.DecodeToWidth"})," method to create a Bitmap object. This is an important insight if you want to display images in your UI and the format (jpg, png, and otherwise) provides a very large high resolution image but you only want to display it in a small portion of your UI. You need to decode the image so that the ",(0,o.jsx)(n.code,{children:"Bitmap"})," that is displayed is not the full resolution. This ",(0,o.jsx)(n.code,{children:"DecodeToWidth"})," method maintains the aspect ratio and efficiently loads to the specified width. This means we will not waste huge amounts of memory to show our album covers even if the image files themselves turn out to be quite large."]}),"\n",(0,o.jsx)(n.p,{children:"Now we need to start loading the Album covers whenever a search query has been returned from the backend. Note that because loading the images takes time and is asynchronous, we may need to cancel loading them if the user makes another search request."}),"\n",(0,o.jsxs)(n.p,{children:["Your ",(0,o.jsx)(n.code,{children:"AlbumViewModel.cs"})," should now look like:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-csharp",children:"using Avalonia.Media.Imaging;\nusing Avalonia.MusicStore.Models;\nusing ReactiveUI;\n\nnamespace Avalonia.MusicStore.ViewModels\n{\n    public class AlbumViewModel : ViewModelBase\n    {\n        private readonly Album _album;\n        private Bitmap? _cover;\n\n        public AlbumViewModel(Album album)\n        {\n            _album = album;\n        }\n\n        public string Artist => _album.Artist;\n\n        public string Title => _album.Title;\n\n        public Bitmap? Cover\n        {\n            get => _cover;\n            private set => this.RaiseAndSetIfChanged(ref _cover, value);\n        }\n\n        public async Task LoadCover()\n        {\n            await using (var imageStream = await _album.LoadCoverBitmapAsync())\n            {\n                Cover = await Task.Run(() => Bitmap.DecodeToWidth(imageStream, 400));\n            }\n        }\n    }\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Open ",(0,o.jsx)(n.code,{children:"MusicStoreViewModel.cs"})," and add the following method."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-csharp",children:"private async void LoadCovers(CancellationToken cancellationToken)\n{\n    foreach (var album in SearchResults.ToList())\n    {\n        await album.LoadCover();\n\n        if (cancellationToken.IsCancellationRequested)\n        {\n            return;\n        }\n    }\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Calling this asynchronous method will iterate through each item in a copy of the ",(0,o.jsx)(n.code,{children:"SearchResults"})," and call our ",(0,o.jsx)(n.code,{children:"AlbumViewModel"}),"'s ",(0,o.jsx)(n.code,{children:"LoadCover"})," method. Creating a copy with ",(0,o.jsx)(n.code,{children:".ToList()"})," is necessary because this method is async and ",(0,o.jsx)(n.code,{children:"SearchResults"})," might be updated by another thread."]}),"\n",(0,o.jsxs)(n.p,{children:["Notice a ",(0,o.jsx)(n.code,{children:"CancellationToken"})," is used to check if we want to stop loading album covers."]}),"\n",(0,o.jsxs)(n.p,{children:["Add this field to ",(0,o.jsx)(n.code,{children:"MusicStoreViewModel"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-csharp",children:"private CancellationTokenSource? _cancellationTokenSource;\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now add the following code to the beginning of ",(0,o.jsx)(n.code,{children:"DoSearch"})," method of ",(0,o.jsx)(n.code,{children:"MusicStoreViewModel"})," after the ",(0,o.jsx)(n.code,{children:"SearchResults.Clear();"})," line."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-csharp",children:"_cancellationTokenSource?.Cancel();\n_cancellationTokenSource = new CancellationTokenSource();\nvar cancellationToken = _cancellationTokenSource.Token;\n"})}),"\n",(0,o.jsxs)(n.p,{children:["If there is an existing request still loading Album art, we can cancel it. Because ",(0,o.jsx)(n.code,{children:"_cancellationTokenSource"})," might be replaced asynchronously we have to store the cancellation token in a local variable."]}),"\n",(0,o.jsxs)(n.p,{children:["Now add the following code to the end of ",(0,o.jsx)(n.code,{children:"DoSearch"})," method of ",(0,o.jsx)(n.code,{children:"MusicStoreViewModel"})," after the ",(0,o.jsx)(n.code,{children:"foreach"})," loop."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-csharp",children:"if (!cancellationToken.IsCancellationRequested)\n{\n    LoadCovers(cancellationToken);\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"DoSearch"})," should now look like this."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-csharp",children:"private async void DoSearch(string s)\n{\n    IsBusy = true;\n    SearchResults.Clear();\n\n    _cancellationTokenSource?.Cancel();\n    _cancellationTokenSource = new CancellationTokenSource();\n    var cancellationToken = _cancellationTokenSource.Token;\n\n    if (!string.IsNullOrWhiteSpace(s))\n    {\n        var albums = await Album.SearchAsync(s);\n\n        foreach (var album in albums)\n        {\n            var vm = new AlbumViewModel(album);\n\n            SearchResults.Add(vm);\n        }\n\n        if (!cancellationToken.IsCancellationRequested)\n        {\n            LoadCovers(cancellationToken);\n        }\n    }\n\n    IsBusy = false;\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:"Now run the application and search for your favourite artist."}),"\n",(0,o.jsx)(n.p,{children:"Notice how the Albums covers load one by one, but that the UI remains responsive."}),"\n",(0,o.jsx)("img",{className:"center",src:s.Z,alt:""})]})}function u(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},97138:(e,n,a)=>{a.d(n,{Z:()=>o});const o=a.p+"assets/images/image-20210310173858088-f5ca46d06244a6c90db13c871d522864.png"},11151:(e,n,a)=>{a.d(n,{Z:()=>l,a:()=>t});var o=a(67294);const i={},s=o.createContext(i);function t(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);