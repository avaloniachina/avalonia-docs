"use strict";(self.webpackChunkavalonia_docs=self.webpackChunkavalonia_docs||[]).push([[56211],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),c=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(o.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),d=r,h=p["".concat(o,".").concat(d)]||p[d]||m[d]||i;return n?a.createElement(h,l(l({ref:t},u),{},{components:n})):a.createElement(h,l({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=d;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[p]="string"==typeof e?e:r,l[1]=s;for(var c=2;c<i;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},61689:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const i=n.p+"assets/images/image-20210310013703557-c7f49755311962856cf4f3124ce58fee.png",l=n.p+"assets/images/image-20210310110401944-4368852f6ae25a54ddac752e593e2ebd.png",s={info:"searching-for-albums",title:"Searching for Albums"},o=void 0,c={unversionedId:"tutorials/music-store-app/searching-for-albums",id:"version-0.10.x/tutorials/music-store-app/searching-for-albums",title:"Searching for Albums",description:"Searching For Albums",source:"@site/i18n/zh-Hans/docusaurus-plugin-content-docs/version-0.10.x/tutorials/music-store-app/searching-for-albums.md",sourceDirName:"tutorials/music-store-app",slug:"/tutorials/music-store-app/searching-for-albums",permalink:"/avalonia-docs/zh-Hans/docs/tutorials/music-store-app/searching-for-albums",draft:!1,editUrl:"https://github.com/AvaloniaUI/avalonia-docs/tree/main/versioned_docs/version-0.10.x/tutorials/music-store-app/searching-for-albums.md",tags:[],version:"0.10.x",frontMatter:{info:"searching-for-albums",title:"Searching for Albums"},sidebar:"documentationSidebar",previous:{title:"Return from Dialog",permalink:"/avalonia-docs/zh-Hans/docs/tutorials/music-store-app/return-from-dialog"},next:{title:"Displaying Images",permalink:"/avalonia-docs/zh-Hans/docs/tutorials/music-store-app/displaying-images"}},u={},p=[{value:"Searching For Albums",id:"searching-for-albums",level:2}],m={toc:p},d="wrapper";function h(e){let{components:t,...n}=e;return(0,r.kt)(d,(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"searching-for-albums"},"Searching For Albums"),(0,r.kt)("p",null,"In order for our application to work we are going to need some business logic. This code is not relevant to the tutorial, except for the fact that it will provide the following services:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Searching Apple Itunes web api for Albums"),(0,r.kt)("li",{parentName:"ul"},"Downloading Album art from the Itunes API."),(0,r.kt)("li",{parentName:"ul"},"Saving / Loading the Albums the user has bought to / from disk.")),(0,r.kt)("p",null,"To add this business logic we need 2 steps."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Add the ItunesSearch nuget package to the project. In Rider right click on our project and select ",(0,r.kt)("inlineCode",{parentName:"li"},"Manage Nuget Packages"))),(0,r.kt)("p",null,"This will open the ",(0,r.kt)("inlineCode",{parentName:"p"},"Packages")," tool at the bottom of the IDE, like so."),(0,r.kt)("p",null,"Search for ",(0,r.kt)("inlineCode",{parentName:"p"},"ItunesSearch")," and press the green ",(0,r.kt)("inlineCode",{parentName:"p"},"+")," button on the right hand side to install it."),(0,r.kt)("img",{className:"center",src:i,alt:""}),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"In the ",(0,r.kt)("inlineCode",{parentName:"li"},"Models")," folder add a new class called ",(0,r.kt)("inlineCode",{parentName:"li"},"Album")," and paste in the following code.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'using System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing iTunesSearch.Library;\n\nnamespace Avalonia.MusicStore.Models\n{\n    public class Album\n    {\n        private static HttpClient s_httpClient = new();\n        private static iTunesSearchManager s_SearchManager = new();\n\n        public Album(string artist, string title, string coverUrl)\n        {\n            Artist = artist;\n            Title = title;\n            CoverUrl = coverUrl;\n        }\n\n        public string Artist { get; set; }\n\n        public string Title { get; set; }\n\n        public string CoverUrl { get; set; }\n\n        private string CachePath => $"./Cache/{Artist} - {Title}";\n\n        public async Task<Stream> LoadCoverBitmapAsync()\n        {\n            if (File.Exists(CachePath + ".bmp"))\n            {\n                return File.OpenRead(CachePath + ".bmp");\n            }\n            else\n            {\n                var data = await s_httpClient.GetByteArrayAsync(CoverUrl);\n\n                return new MemoryStream(data);\n            }\n        }\n\n        public async Task SaveAsync()\n        {\n            if (!Directory.Exists("./Cache"))\n            {\n                Directory.CreateDirectory("./Cache");\n            }\n\n            using (var fs = File.OpenWrite(CachePath))\n            {\n                await SaveToStreamAsync(this, fs);\n            }\n        }\n\n        public Stream SaveCoverBitmapStream()\n        {\n            return File.OpenWrite(CachePath + ".bmp");\n        }\n\n        private static async Task SaveToStreamAsync(Album data, Stream stream)\n        {\n            await JsonSerializer.SerializeAsync(stream, data).ConfigureAwait(false);\n        }\n\n        public static async Task<Album> LoadFromStream(Stream stream)\n        {\n            return (await JsonSerializer.DeserializeAsync<Album>(stream).ConfigureAwait(false))!;\n        }\n\n        public static async Task<IEnumerable<Album>> LoadCachedAsync()\n        {\n            if (!Directory.Exists("./Cache"))\n            {\n                Directory.CreateDirectory("./Cache");\n            }\n\n            var results = new List<Album>();\n\n            foreach (var file in Directory.EnumerateFiles("./Cache"))\n            {\n                if (!string.IsNullOrWhiteSpace(new DirectoryInfo(file).Extension)) continue;\n\n                await using var fs = File.OpenRead(file);\n                results.Add(await Album.LoadFromStream(fs).ConfigureAwait(false));\n            }\n\n            return results;\n        }\n\n        public static async Task<IEnumerable<Album>> SearchAsync(string searchTerm)\n        {\n            var query = await s_SearchManager.GetAlbumsAsync(searchTerm).ConfigureAwait(false);\n\n            return query.Albums.Select(x =>\n                new Album(x.ArtistName, x.CollectionName, x.ArtworkUrl100.Replace("100x100bb", "600x600bb")));\n        }\n    }\n}\n')),(0,r.kt)("p",null,"Now that we have the backend code, we can query for Albums as the user types."),(0,r.kt)("p",null,"Open ",(0,r.kt)("inlineCode",{parentName:"p"},"MusicStoreViewModel.cs")," and add the following code to the constructor."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"this.WhenAnyValue(x => x.SearchText)\n        .Throttle(TimeSpan.FromMilliseconds(400))\n        .ObserveOn(RxApp.MainThreadScheduler)\n        .Subscribe(DoSearch!);\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"WhenAnyValue")," method is provided thanks to Reactive UI and it takes a lambda expression of the property we want to ",(0,r.kt)("inlineCode",{parentName:"p"},"Observe"),". By selecting the ",(0,r.kt)("inlineCode",{parentName:"p"},"SearchText")," property we will fire an event when ever the user types."),(0,r.kt)("p",null,"Since users can type quite quickly it is not a good idea to try and run a search on every keypress. This is where the ",(0,r.kt)("inlineCode",{parentName:"p"},"Throttle")," call comes in. ",(0,r.kt)("inlineCode",{parentName:"p"},"Throttle")," is built into .NET and it takes a ",(0,r.kt)("inlineCode",{parentName:"p"},"TimeSpan")," in this case 400 milliseconds."),(0,r.kt)("p",null,"This means we will only see a value if the user has stopped typing for 400 milliseconds or longer."),(0,r.kt)("p",null,"The final call ",(0,r.kt)("inlineCode",{parentName:"p"},"ObserveOn")," is required to ensure that our ",(0,r.kt)("inlineCode",{parentName:"p"},"DoSearch")," method is called on the ",(0,r.kt)("inlineCode",{parentName:"p"},"UIThread"),". The UI must only be updated on the UI thread. The ",(0,r.kt)("inlineCode",{parentName:"p"},"Throttle")," call can cause the result to be emitted on some random thread, ",(0,r.kt)("inlineCode",{parentName:"p"},"ObserveOn")," dispatches it back to the ",(0,r.kt)("inlineCode",{parentName:"p"},"UIThread"),"."),(0,r.kt)("p",null,"Our ",(0,r.kt)("inlineCode",{parentName:"p"},"AlbumViewModel")," will need some properties to hold the artist name and album title. Note that because these properties will not change in the UI during runtime, we do not need to use the ",(0,r.kt)("inlineCode",{parentName:"p"},"RaiseAndSetIfChanged")," method. We can simply expose them as plain ",(0,r.kt)("inlineCode",{parentName:"p"},"get")," only properties."),(0,r.kt)("p",null,"Change the ",(0,r.kt)("inlineCode",{parentName:"p"},"AlbumViewModel")," code so that it matches the following."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"private readonly Album _album;\n\npublic AlbumViewModel(Album album)\n{\n    _album = album;\n}\n\npublic string Artist => _album.Artist;\n\npublic string Title => _album.Title;\n")),(0,r.kt)("p",null,"Now our ",(0,r.kt)("inlineCode",{parentName:"p"},"AlbumViewModel")," directly wraps the ",(0,r.kt)("inlineCode",{parentName:"p"},"Album")," class ","(",(0,r.kt)("inlineCode",{parentName:"p"},"ViewModel")," wraps the ",(0,r.kt)("inlineCode",{parentName:"p"},"Model"),")"," this is a common pattern."),(0,r.kt)("p",null,"Now we are ready to query the backend for real data. Our business logic or model code from ",(0,r.kt)("inlineCode",{parentName:"p"},"Album.cs")," provides a convenient method to do this."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"public static async Task<IEnumerable<Album>> SearchAsync(string searchTerm)\n")),(0,r.kt)("p",null,"Calling this method will return an ",(0,r.kt)("inlineCode",{parentName:"p"},"IEnumerable")," of ",(0,r.kt)("inlineCode",{parentName:"p"},"Albums"),". We can call this every time the user's typing is ",(0,r.kt)("inlineCode",{parentName:"p"},"throttled"),", get the data, then clear the list of ",(0,r.kt)("inlineCode",{parentName:"p"},"ViewModels")," from the ",(0,r.kt)("inlineCode",{parentName:"p"},"SearchResults")," ",(0,r.kt)("inlineCode",{parentName:"p"},"ObservableCollection")," and enumerate each item returned adding an ",(0,r.kt)("inlineCode",{parentName:"p"},"AlbumViewModel")," to the ",(0,r.kt)("inlineCode",{parentName:"p"},"SearchResults")," for each ",(0,r.kt)("inlineCode",{parentName:"p"},"Album"),". The UI will automatically update and represent the ",(0,r.kt)("inlineCode",{parentName:"p"},"state")," of our ",(0,r.kt)("inlineCode",{parentName:"p"},"ViewModel")," as we do this."),(0,r.kt)("p",null,"To implement this functionality, add the following code to ",(0,r.kt)("inlineCode",{parentName:"p"},"MusicStoreViewModel.cs")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"private CancellationTokenSource? _cancellationTokenSource;\n\nprivate async void DoSearch(string s)\n{\n    IsBusy = true;\n    SearchResults.Clear();\n\n    if (!string.IsNullOrWhiteSpace(s))\n    {\n        var albums = await Album.SearchAsync(s);\n\n        foreach (var album in albums)\n        {\n            var vm = new AlbumViewModel(album);\n\n            SearchResults.Add(vm);\n        }\n    }\n\n    IsBusy = false;\n}\n")),(0,r.kt)("p",null,"Before we run it, we will need to remove our old dummy data from the constructor of ",(0,r.kt)("inlineCode",{parentName:"p"},"MusicStoreViewModel"),". Remove the following lines..."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"SearchResults.Add(new AlbumViewModel());\nSearchResults.Add(new AlbumViewModel());\nSearchResults.Add(new AlbumViewModel());\n")),(0,r.kt)("p",null,"Now run the application and click the store button, then search for an artist or album name. If all has gone to plan you should see the progressbar animating whilst the server is busy processing the request and then you should see some results appear in the list."),(0,r.kt)("img",{className:"center",src:l,alt:""}))}h.isMDXComponent=!0}}]);